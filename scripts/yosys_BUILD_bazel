# yosys/BUILD.bazel
load("@rules_foreign_cc//foreign_cc:defs.bzl", "cmake")

package(default_visibility = ["//visibility:public"])


# genrule(
#     name = "header",
#     srcs = ["libs/cxxopts/include/cxxopts.hpp"],
#     outs = ["cxxopts.hpp"],
#     tools = [],
#     cmd = """
#         cp yosys/libs/cxxopts/include/cxxopts.hpp $(location cxxopts.hpp)
#     """,
#     visibility = ["//visibility:public"],
# )

cc_library(
    name = "cxxopts_header",
    hdrs = ["libs/cxxopts/include/cxxopts.hpp"],
    deps  = [],
    visibility = ["//visibility:public"],
)


filegroup(
    name = "srcs",
    srcs = glob(
        ["**/*"],
        # Explicitly exclude the cxxopts directory, since it's now a separate dependency.
        exclude = [
            "BUILD.bazel",
            "libs/cxxopts/**",
        ],
    ),
)

cmake(
    name             = "yosys",
    lib_source       = ":srcs",
    # Depend on the cxxopts library from its own repository.
    deps             = [":cxxopts_header"],
    build_args       = ["--parallel", "32"],
    # cache_entries    = {"ENABLE_LIBYOSYS": "1"},
    # The yosys CMake scripts still have hardcoded paths. This creates a dummy
    # directory to prevent CMake from failing its path existence checks.
    out_binaries     = ["yosys", "yosys-config"],
    out_shared_libs  = ["libyosys.so"],
)

alias(
    name = "test_example",
    actual = "//scripts:test_svql_driver",
)